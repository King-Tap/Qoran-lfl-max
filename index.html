<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ù„Ù…ØµØ­Ù Ø§Ù„Ø´Ø§Ù…Ù„ - Ø£ÙˆÙÙ„Ø§ÙŠÙ†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script> <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@500;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f4f7f6; user-select: none; }
        .quran-font { font-family: 'Amiri', serif; line-height: 2.5; text-align: justify; font-size: 1.8rem; }
        .status-bar { font-size: 0.7rem; padding: 2px 10px; background: #064e3b; color: #fff; text-align: center; }
    </style>
</head>
<body>

<div id="app" class="flex flex-col h-screen">
    <div class="status-bar" v-if="isOffline">ÙˆØ¶Ø¹ Ø§Ù„Ø£ÙˆÙÙ„Ø§ÙŠÙ† Ù†Ø´Ø· âœ… (ÙŠØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª)</div>

    <header class="bg-emerald-900 text-white p-4 shadow-md flex justify-between items-center shrink-0">
        <h1 class="font-bold text-lg">ğŸ“– Ø§Ù„Ù…ØµØ­Ù Ø§Ù„Ø´Ø§Ù…Ù„</h1>
        <button v-if="!isDownloaded" @click="startDownload" :disabled="downloading" class="bg-yellow-500 text-xs px-3 py-1 rounded-full font-bold animate-pulse">
            {{ downloading ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...' : 'ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…ØµØ­Ù Ù„Ù„Ø¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ù†Øª' }}
        </button>
    </header>

    <main class="flex-1 overflow-y-auto p-4">
        <div v-if="view === 'index'">
            <input v-model="search" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø³ÙˆØ±Ø©..." class="w-full p-4 mb-4 rounded-2xl border-none shadow-sm outline-none focus:ring-2 focus:ring-emerald-500">
            
            <div class="grid gap-3">
                <div v-for="s in filteredSurahs" :key="s.number" @click="loadSurah(s.number)" 
                     class="bg-white p-5 rounded-2xl shadow-sm border-r-8 border-emerald-700 cursor-pointer active:scale-95 transition-transform flex justify-between items-center">
                    <div>
                        <span class="text-emerald-800 font-bold ml-2">#{{ s.number }}</span>
                        <span class="text-xl font-bold text-gray-800">{{ s.name }}</span>
                    </div>
                    <span class="text-xs text-gray-400">Ø¢ÙŠØ§ØªÙ‡Ø§: {{ s.numberOfAyahs }}</span>
                </div>
            </div>
        </div>

        <div v-if="view === 'reading' && currentSurah" class="bg-white p-6 rounded-3xl shadow-sm min-h-full">
            <div class="text-center mb-8">
                <h2 class="text-4xl font-bold text-emerald-900 mb-2">{{ currentSurah.name }}</h2>
                <div class="text-2xl text-emerald-600 font-serif" v-if="currentSurah.number !== 1 && currentSurah.number !== 9">
                    Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„Ù‘ÙÙ‡Ù Ø§Ù„Ø±Ù‘ÙØ­Ù’Ù…ÙÙ°Ù†Ù Ø§Ù„Ø±Ù‘ÙØ­ÙÙŠÙ…Ù
                </div>
            </div>
            <div class="quran-font text-gray-800">
                <span v-for="ayah in currentSurah.ayahs">
                    {{ ayah.text }} <span class="inline-flex items-center justify-center w-8 h-8 rounded-full border border-emerald-200 text-sm font-sans mx-1 text-emerald-700">{{ ayah.numberInSurah }}</span>
                </span>
            </div>
            <button @click="view = 'index'" class="w-full mt-10 p-4 bg-gray-100 rounded-2xl font-bold text-gray-500">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙÙ‡Ø±Ø³</button>
        </div>
    </main>
</div>

<script>
const { createApp, ref, onMounted, computed } = Vue;

// Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Dexie (Ù„Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¯Ø§Ø¦Ù… Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ)
const db = new Dexie("QuranOfflineDB");
db.version(1).stores({ surahs: "number, name, ayahs" });

createApp({
    setup() {
        const view = ref('index');
        const search = ref('');
        const allSurahs = ref([]);
        const currentSurah = ref(null);
        const downloading = ref(false);
        const isDownloaded = ref(false);
        const isOffline = ref(!navigator.onLine);

        onMounted(async () => {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…ØµØ­Ù Ù…Ø­Ù…Ù„Ø§Ù‹ Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const count = await db.surahs.count();
            if (count >= 114) {
                isDownloaded.value = true;
                allSurahs.value = await db.surahs.toArray();
            } else {
                fetchIndex(); // Ø¬Ù„Ø¨ Ø§Ù„ÙÙ‡Ø±Ø³ ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ ØªØ­Ù…ÙŠÙ„
            }
            window.addEventListener('offline', () => isOffline.value = true);
            window.addEventListener('online', () => isOffline.value = false);
        });

        const fetchIndex = async () => {
            const res = await fetch('https://api.alquran.cloud/v1/surah');
            const data = await res.json();
            allSurahs.value = data.data;
        };

        const startDownload = async () => {
            downloading.value = true;
            try {
                // Ø¬Ù„Ø¨ Ø§Ù„Ù…ØµØ­Ù ÙƒØ§Ù…Ù„Ø§Ù‹ (Ù†Øµ Ø¹Ø«Ù…Ø§Ù†ÙŠ) ÙÙŠ Ø·Ù„Ø¨ ÙˆØ§Ø­Ø¯
                const res = await fetch('https://api.alquran.cloud/v1/quran/quran-uthmani');
                const data = await res.json();
                
                // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø³ÙˆØ± Ø§Ù„Ù€ 114 ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡Ø§ØªÙ
                await db.surahs.bulkPut(data.data.surahs);
                isDownloaded.value = true;
                allSurahs.value = data.data.surahs;
                alert("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØµØ­Ù ÙƒØ§Ù…Ù„Ø§Ù‹! Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø³ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù† Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª Ù„Ù„Ø£Ø¨Ø¯.");
            } catch (e) {
                alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª");
            } finally {
                downloading.value = false;
            }
        };

        const loadSurah = async (num) => {
            if (isDownloaded.value) {
                currentSurah.value = await db.surahs.get(num);
            } else {
                const res = await fetch(`https://api.alquran.cloud/v1/surah/${num}/quran-uthmani`);
                const data = await res.json();
                currentSurah.value = data.data;
            }
            view.value = 'reading';
        };

        const filteredSurahs = computed(() => allSurahs.value.filter(s => s.name.includes(search.value)));

        return { view, search, allSurahs, currentSurah, downloading, isDownloaded, isOffline, startDownload, loadSurah, filteredSurahs };
    }
}).mount('#app');
</script>
</body>
</html>

